<?php
$includeNavbar = true;
if ($includeNavbar) {
    include("navbar.php"); // Inclui a navbar
}

require("conn.php");

// Get the ID from the URL parameter
$comprar = isset($_GET['comprar']) ? $_GET['comprar'] : null;

// Check if the 'comprar' parameter is provided
if (!$comprar) {
    // Handle the case when the 'comprar' parameter is missing
    echo "Produto não especificado.";
    exit();
}

// Query the data for the given ID
$sql = "SELECT id_produto, path, nome_produto, descricao, preco, quantidade_produto, id_empresa_cad FROM produtos WHERE id_produto = :comprar";
$stmt = $pdo->prepare($sql);
$stmt->execute(['comprar' => $comprar]);
$row = $stmt->fetch();

// Check if the product exists
if (!$row) {
    // Handle the case when the product doesn't exist
    echo "Produto não encontrado.";
    exit();
}

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $quantidade = $_POST['quantidade'];

    // Insert a new record into the "pedidos" table
    $sql = "INSERT INTO pedidos (id_usuario, id_produto, quantidade, valor_total, endereco_entrega, status_pedido, id_empresa)
            VALUES (:idUsuario, :idProduto, :quantidade, :valorTotal, :enderecoEntrega, 'Pendente', :idEmpresa)";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        'idUsuario' => $_SESSION['id_usuario'],
        'idProduto' => $row['id_produto'],
        'quantidade' => $quantidade,
        'valorTotal' => $row['preco'] * $quantidade,
        'enderecoEntrega' => $_SESSION['endereco'],
        'idEmpresa' => $row['id_empresa_cad']
    ]);

    // Update the "produtos" table to decrement the quantity
    $sql = "UPDATE produtos SET quantidade_produto = quantidade_produto - :quantidade WHERE id_produto = :idProduto";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        'quantidade' => $quantidade,
        'idProduto' => $row['id_produto']
    ]);

    // Display a popup with the company's phone number
    $telefoneEmpresa = "123456789"; // Replace with the actual phone number from the database
    echo "<script>alert('Entre em contato com a empresa pelo telefone: $telefoneEmpresa');</script>";

    // Redirect to the "meus_pedidos.php" page
    header("Location: meus_pedidos.php");
    exit();
}
?>

<head>
    <link rel="stylesheet" href="CSS/tela_compra.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <title>Página Inicial</title>
</head>

<body>
    <div class='product-box'>
        <div class='product-details'>
            <div class='row'>
                <div class='col-md-6'>
                    <div class='image-container'>
                        <img class='imagem' src='upload/<?php echo $row['path']; ?>' alt='Product image'>
                    </div>
                    <div class="box"></div>
                </div>
                <div class='col-md-6'>
                    <div class="letras">
                        <p type="text" name='id_produto'> <?php echo $row['id_produto']; ?></p>

                        <h3 class='product-name'><?php echo $row['nome_produto']; ?></h3>
                        <p class='product-price'>R$ <?php echo $row['preco']; ?></p>
                        <p class='product-description'><?php echo $row['descricao']; ?></p>

                        <!-- Form for entering the quantity and finalizing the order -->
                        <form method="POST">
                            <label for="quantidade">Quantidade:</label>
                            <input type="number" id="quantidade" name="quantidade" required min="1" max="<?php echo $row['quantidade_produto']; ?>">
                            <button type="submit" class="btn btn-primary">Finalizar Pedido</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

CSS 


/* Estilos para a caixa do produto */
.product-box {
  display: flex;    
  align-items: flex-start;
  border: 1px solid #e5e5e5;
  background-color: #ffffff;
  padding: 20px;
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
}

/* Estilos para a imagem do produto */
.image-container {
  flex-shrink: 0;
  margin-right: 20px;
}

.imagem {
  max-width: 100%;
  max-height: 300px;
}

/* Estilos para as informações do produto */
.product-info {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

.product-name {
  font-size: 24px;
  margin-top: 0;
  color: #333333;
}

.product-price {
  font-size: 24px;
  font-weight: bold;
  margin-top: 5px;
  color: #00a650;
}

.product-description {
  margin-top: 10px;
  color: #333333;
}

/* Estilos para o campo de quantidade */
#quantidade {
  width: 50px;
  padding: 5px;
}

/* Estilos para o botão de finalizar pedido */
.btn {
  padding: 10px 20px;
  font-size: 18px;
  background-color: #00a650;
  color: #ffffff;
  border: none;
  cursor: pointer;
  border-radius: 5px;
  text-decoration: none;
}

.btn:hover {
  background-color: #008d41;
}

/* Estilos para o rótulo do campo de quantidade */
label {
  display: block;
  margin-bottom: 10px;
  color: #333333;
  font-weight: bold;
}

/* Estilos para a divisória horizontal */
.divisor {
  margin: 20px 0;
  border-bottom: 1px solid #e5e5e5;
}

